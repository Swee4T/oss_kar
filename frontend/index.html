<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSS-KAR Konfigurator</title>
    <link rel="stylesheet" href="style/style.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

    
<body>
    <div class="header">
        <h1>OSS-KAR Konfigurator</h1>
        <p>Konfiguriere hier dein OSS-KAR</p>
    </div>

    <div class="loading" id="loading">
        <p>Lade Optionen...</p>
    </div>

    <div class="config-section select_engine">
        <h3 class="title_car_options">WÃ¤hle deinen Motor</h3>
        <select name="engine" id="engine-select">
        </select>
    </div>

    <div class="config-section select_color">
        <h3 class="title_car_options">Farbe</h3>
        <div id="paint-container">
        </div>
    </div>

    <div class="config-section select_wheels">
        <h3 class="title_car_options">Felgen</h3>
        <select name="wheels" id="wheels-select">
        </select>
    </div>

    <div class="config-section select_extra_options">
        <h3 class="title_car_options">WÃ¤hle bis zu 5 Extras</h3>
        <div id="extras-container">
        </div>
    </div>

    <div class="price-display">
        <h2 id="total-price">25.000 â‚¬</h2>
        <p>Gesamtpreis inkl. aller Optionen</p>

        <button class="button" id="generateConfigButton">
            Teile deine Konfiguration
        </button>
        <div class="result_config_url">

        </div>

    </div>


    <script>
        // online
        const API_BASE = "/osskar/api"
        // local
        // const API_BASE = "/api"

        let carOptions = {};

        $(document).ready(function() {
            console.log('ðŸš€ OSS-KAR Frontend loaded!');
            loadCarOptions();
        });

        function loadCarOptions() {
            $('#loading').show();
            
            $.get(`${API_BASE}/options`, function(carOptionsData) {
                console.log('Options loaded:', carOptionsData);
                carOptions = carOptionsData;
                
                buildSelection('dropdown', 'engine', carOptionsData.engine);
                buildSelection('dropdown', 'wheels', carOptionsData.wheels);
                buildSelection('radio', 'paint', carOptionsData.paint);
                buildSelection('checkbox', 'extras', carOptionsData.extras);
                

                setupEventListeners();
                
                $('#loading').hide();
            })
            .fail(function() {
                console.error('Loading failed');
                $('#loading').hide();
                alert('Fehler beim Laden der Optionen');
            });
        }

        function buildSelection(type, name, data) {
            if (type === 'dropdown') {

                $(`#${name}-select`).empty();
                $(`#${name}-select`).append(`<option value="">WÃ¤hlen...</option>`);
                

                data.forEach(item => {
                    $(`#${name}-select`).append(
                        `<option value="${item.id}">${item.name} - ${item.price}â‚¬</option>`
                    );
                });
            } 
            else if (type === 'radio') {
                $(`#${name}-container`).empty();
                
                data.forEach(item => {
                    $(`#${name}-container`).append(`
                        <input type="radio" id="${name}-${item.id}" name="${name}" value="${item.id}">
                        <label for="${name}-${item.id}">${item.name} - ${item.price}â‚¬</label><br>
                    `);
                });
            }
            else if (type === 'checkbox') {
                $(`#${name}-container`).empty();
                
                data.forEach(item => {
                    $(`#${name}-container`).append(`
                        <input type="checkbox" id="${name}-${item.id}" name="${name}" value="${item.id}">
                        <label for="${name}-${item.id}">${item.name} - ${item.price}â‚¬</label><br>
                    `);
                });
            }
        }

        function setupEventListeners() {

            $('select[name="engine"]').change(function() {
                console.log('Engine changed:', $(this).val());
                calculatePrice();
            });

            $('input[name="paint"]').change(function() {
                console.log('Paint changed:', $(this).val());
                calculatePrice();
            });

            $('select[name="wheels"]').change(function() {
                console.log('Wheels changed:', $(this).val());
                calculatePrice();
            });

            $('input[name="extras"]').change(function() {
                let selectedExtras = $('input[name="extras"]:checked');
                
                if (selectedExtras.length > 5) {
                    $(this).prop('checked', false);
                    alert('Maximal 5 Extras erlaubt!');
                    return;
                }
                
                console.log('Extras changed:', selectedExtras.length, 'selected');
                calculatePrice();
            });

            $('#generateConfigButton').click(function() {
            console.log('Generate button clicked!');
            let configData = generateConfig();

                $.ajax({
                    url: `${API_BASE}/generate`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(configData), 
                    success: function(response) {
                        console.log('Generated URL:', response.configUrl);
                        $('.result_config_url').html(`
                            <div style="margin-top: 15px; padding: 10px; background: #fffff; border-radius: 15px;">
                                <strong>Dein Konfigurations-Link:</strong><br>
                                <input type="text" value="${response.fullUrl}" readonly style="width: 70%; margin: 10px ; padding: 5px;">
                                </div>
                        `);
                    },
                    error: function(xhr, status, error) {
                        console.error('Generate failed:', error);
                        alert('Fehler beim Generieren der URL');
                    }
                });
            });
        }

        function generateConfig() {

            let engineId = $('select[name="engine"]').val() || null;
            let paintId = $('input[name="paint"]:checked').val() || null;
            let wheelsId = $('select[name="wheels"]').val() || null;
            let extrasIds = [];
            $('input[name="extras"]:checked').each(function() {
                extrasIds.push(parseInt($(this).val()));
            });


            let configData = {
                engineId: engineId ? parseInt(engineId) : null,
                paintId: paintId ? parseInt(paintId) : null,
                wheelsId: wheelsId ? parseInt(wheelsId) : null,
                extrasIds: extrasIds
            };
            console.log(configData);
            return configData;
        }


        function calculatePrice() {
            let configData = generateConfig();
            
            if (!configData.engineId && !configData.paintId && !configData.wheelsId && configData.extrasIds.length === 0) {
                $('#total-price').text('25.000 â‚¬');
                return;
            }

            $.ajax({
                url: `${API_BASE}/calculate`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(configData),
                success: function(response) {
                    console.log('Price calculated:', response);
                    $('#total-price').text(formatPrice(response.totalPrice));
                },
                error: function(xhr, status, error) {
                    console.error('Price calculation failed:', error);
                    $('#total-price').text('Fehler bei Berechnung');
                }
            });
        }

        

        function formatPrice(price) {
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(price);
        }
    </script>
</body>

</html>
